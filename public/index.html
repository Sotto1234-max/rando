<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat WebApp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            accent: '#10B981',
            light: '#F3F4F6'
          }
        }
      }
    }
  </script>
</head>
<body class="bg-light font-sans">

<!-- Login Form -->
<div id="login" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-white px-4">
  <div class="bg-white shadow-2xl p-8 rounded-2xl w-full max-w-sm space-y-4">
    <h2 class="text-3xl font-bold text-center text-primary">Welcome Back</h2>
    <input id="name" type="text" placeholder="Name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" />
    <input id="age" type="number" placeholder="Age" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" />
    <select id="gender" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
      <option value="">Select Gender</option>
      <option value="male">Male</option>
      <option value="female">Female</option>
    </select>
    <input id="photo" type="file" accept="image/*" class="w-full px-4 py-2" />
    <button onclick="login()" class="w-full py-3 rounded-lg bg-primary text-white font-semibold hover:bg-blue-600 transition">Login</button>
  </div>
</div>

<!-- Main App -->
<div id="app" class="hidden flex flex-col h-screen">

  <!-- Header -->
  <header class="bg-white shadow-md p-4 flex flex-col sm:flex-row items-center justify-between gap-4">
    <div class="space-x-2">
      <button onclick="filterUsers('all')" class="text-primary font-medium">All</button>
      <button onclick="filterUsers('male')" class="text-primary font-medium">Male</button>
      <button onclick="filterUsers('female')" class="text-primary font-medium">Female</button>
      <button onclick="showInbox()" class="text-accent font-medium ml-4">Inbox</button>
    </div>
    <div class="flex items-center gap-3">
      <img id="user-photo" class="w-9 h-9 rounded-full border object-cover" />
      <span id="user-name" class="font-medium text-gray-700"></span>
    </div>
  </header>

  <!-- Body Wrapper -->
  <div class="flex-1 flex overflow-hidden">

    <!-- Sidebar / User List -->
    <aside class="w-full sm:w-80 bg-white border-r overflow-y-auto p-4" id="user-panel">
      <div id="user-list" class="space-y-2"></div>
    </aside>

    <!-- Chat Area -->
    <main id="chat-body" class="hidden flex-1 flex flex-col bg-gray-50">

      <!-- Chat Header -->
      <div class="flex items-center justify-between p-4 bg-white shadow-md">
        <div class="flex items-center gap-3">
          <img id="chat-user-photo" class="w-10 h-10 rounded-full object-cover" />
          <span id="chat-user-name" class="font-semibold text-lg"></span>
        </div>
        <div class="flex items-center gap-3">
          <button class="text-accent border border-accent px-4 py-1 rounded-lg hover:bg-green-50 transition">Video Call</button>
          <button onclick="closeChat()" class="text-red-500 text-xl font-bold">&times;</button>
        </div>
      </div>

      <!-- Chat Messages -->
      <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-2"></div>

      <!-- Chat Input -->
      <div class="p-4 bg-white border-t flex items-center gap-3">
        <input id="message-input" type="text" placeholder="Type a message..." class="flex-1 border px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" />
        <input id="image-input" type="file" accept="image/*" class="hidden" />
        <button onclick="document.getElementById('image-input').click()" class="text-primary text-2xl">ðŸ“·</button>
        <button onclick="sendMessage()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">Send</button>
      </div>
    </main>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  let currentUser = null;
  let selectedUser = null;
  const users = [];
  const messages = {};

  const socket = io();

  function login() {
  const name = document.getElementById('name').value;
  const age = document.getElementById('age').value;
  const gender = document.getElementById('gender').value;
  const photo = document.getElementById('photo').files[0];

  if (!name || !age || !gender) {
    alert('Please fill out all fields.');
    return;
  }

  const reader = new FileReader();

  if (photo) {
    reader.onload = () => {
      currentUser = { name, age, gender, photo: reader.result };
      finalizeLogin();
    };
    reader.readAsDataURL(photo);
  } else {
    currentUser = { name, age, gender, photo: '' };
    finalizeLogin();
  }

  function finalizeLogin() {
    document.getElementById('user-name').textContent = name;
    document.getElementById('user-photo').src = currentUser.photo || 'https://via.placeholder.com/40';
    document.getElementById('login').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');

    socket.emit('login', currentUser);
    //addDummyUsers();
    renderUsers();
  }
}


  function addDummyUsers() {
    const dummy = [
      { name: 'Anik', gender: 'male', photo: 'https://i.pravatar.cc/150?img=10' },
      { name: 'Lima', gender: 'female', photo: 'https://i.pravatar.cc/150?img=20' },
      { name: 'Jamal', gender: 'male', photo: 'https://i.pravatar.cc/150?img=30' },
      { name: 'Tania', gender: 'female', photo: 'https://i.pravatar.cc/150?img=40' }
    ];
    users.push(...dummy);
    dummy.forEach(user => {
      messages[user.name] = [];
    });
  }

  function renderUsers(filter = 'all') {
    const list = document.getElementById('user-list');
    list.innerHTML = '';
    users.forEach(user => {
      if (user.name === currentUser.name) return;
      if (filter !== 'all' && user.gender !== filter) return;

      const unread = messages[user.name]?.some(msg => !msg.read);
      list.innerHTML += `
        <div onclick="openChat('${user.name}')" class="cursor-pointer p-2 hover:bg-gray-100 flex items-center gap-3">
          <img src="${user.photo}" class="w-10 h-10 rounded-full"/>
          <span class="flex-1">${user.name}</span>
          ${unread ? '<span class="w-3 h-3 bg-blue-500 rounded-full"></span>' : ''}
        </div>
      `;
    });
  }

  socket.on('receiveMessage', (msg) => {
    if (!messages[msg.from]) messages[msg.from] = [];
    msg.read = false;
    messages[msg.from].push(msg);

    if (selectedUser && selectedUser.name === msg.from) {
      msg.read = true;
      renderMessages();
    } else {
      renderUsers();
    }
  });

  socket.on('userList', (userList) => {
    users.length = 0;
    users.push(...userList);
    renderUsers();
  });

  function filterUsers(type) {
    renderUsers(type);
  }

  function showInbox() {
    const list = document.getElementById('user-list');
    list.innerHTML = '';

    for (let name in messages) {
      const user = users.find(u => u.name === name);
      if (!user) continue;
      const unread = messages[name].some(m => !m.read);
      list.innerHTML += `
        <div onclick="openChat('${name}')" class="cursor-pointer p-2 hover:bg-gray-100 flex items-center gap-3">
          <img src="${user.photo}" class="w-10 h-10 rounded-full"/>
          <span class="flex-1">${name}</span>
          ${unread ? '<span class="w-3 h-3 bg-blue-500 rounded-full"></span>' : ''}
        </div>
      `;
    }
  }

  function openChat(userName) {
    selectedUser = users.find(u => u.name === userName);
    document.getElementById('chat-user-name').textContent = selectedUser.name;
    document.getElementById('chat-user-photo').src = selectedUser.photo;

    document.getElementById('user-panel').classList.add('hidden');
    document.getElementById('chat-body').classList.remove('hidden');

    messages[userName]?.forEach(msg => msg.read = true);
    renderMessages();
  }

  function renderMessages() {
    const box = document.getElementById('chat-messages');
    box.innerHTML = '';
    const chat = messages[selectedUser.name] || [];
    chat.forEach(msg => {
      const align = msg.from === currentUser.name ? 'justify-end text-right' : 'justify-start text-left';
      const color = msg.from === currentUser.name ? 'bg-blue-100' : 'bg-gray-200';
      box.innerHTML += `
        <div class="flex ${align}">
          <div class="${color} p-2 rounded max-w-xs">
            ${msg.image ? `<img src="${msg.image}" class="max-w-full mb-1"/>` : ''}
            ${msg.text || ''}
          </div>
        </div>
      `;
    });
    box.scrollTop = box.scrollHeight;
  }

  document.getElementById('image-input').addEventListener('change', function () {
    const file = this.files[0];
    const reader = new FileReader();
    reader.onload = () => {
      const imageMsg = { from: currentUser.name, to: selectedUser.name, image: reader.result, read: true };
      if (!messages[selectedUser.name]) messages[selectedUser.name] = [];
      messages[selectedUser.name].push(imageMsg);
      renderMessages();
      socket.emit('sendMessage', imageMsg);
    };
    reader.readAsDataURL(file);
  });

  function sendMessage() {
    const input = document.getElementById('message-input');
    const text = input.value.trim();
    if (!text) return;
    if (!messages[selectedUser.name]) messages[selectedUser.name] = [];

    const msg = { from: currentUser.name, to: selectedUser.name, text, read: true };
    messages[selectedUser.name].push(msg);
    input.value = '';
    renderMessages();
    socket.emit('sendMessage', msg);
  }

  function closeChat() {
    document.getElementById('chat-body').classList.add('hidden');
    document.getElementById('user-panel').classList.remove('hidden');
    renderUsers();
  }
</script>
  <script> function handleBotMessages(user, socket) {
  const isMale = user.gender === 'male';
  const botGroup = isMale ? femaleBots : maleBots;

  // Randomly select 4â€“5 bots
  const botsToMessage = botGroup.sort(() => 0.5 - Math.random()).slice(0, 5);

  botsToMessage.forEach((bot, index) => {
    const delay = Math.floor(Math.random() * 10000) + 10000; // 10â€“20s

    setTimeout(() => {
      const message = botMessages[Math.floor(Math.random() * botMessages.length)];

      const msg = {
        from: bot.name,
        to: user.name,
        text: message,
        read: false
      };

      // Save in memory (optional, handled on frontend too)
      // Send message to real user
      io.to(user.id).emit('receiveMessage', msg);
    }, delay + index * 1000); // stagger slightly to avoid exact same timestamp
  });
}
 </script>
</body>
</html>
